# Raft 协议

## Leader 选举

## 日志复制

## 网络分区

## 日志压缩及快照
创建快照文件时，会将整个节点的状态进行序列化，然后写入稳定的持久化存储。

多个快照文件存在的意义？如果旧的日志已经被压缩，应该只有最新的快照才能恢复完整数据

## linearizablity(线性一致性)语义
客户端对于每个请求都产生一个唯一的序列号，然后 由服务端为每个客户端维护一个 Session， 并对每个请求进行去重。当服务端接收到一个请求时， 会检测其序列号，如果该请求 己经被执行过了，那么就立即返回结果，而不会重新执行。

## 只读请求
1. 网络分区后，少数派节点读请求失败
etcd 默认使用 ReadIndex 机制来实现线性一致性读。当 etcd 节点处理读请求时，节点必须先向 leader 查询 commitIndex，少数派无法联 leader，导致读取失败。如果开启非线性一致性读请求，则不会失败。

非线性一致性读开启方式：
- SDK 访问需要配置 WithSerializable 选项（默认并不开启）
- etcdctl 访问需要配置 --consistency=s 选项

2. 网络分区后，旧的 leader 节点处于少数派


## PreVote 状态
Raft 协议为了优化此次无意义的选举，给节点添加了一个 PreVote 的状态：当某个节点要发起选举之前，需要先进入 PreVote 的状态。在 PreVot巳状态下的节点会先尝试连接集群中的其他节点，如果能够成功连接到半数以上的节点，才能真正切换成 Candidate 状态并发起新一轮的选举。

